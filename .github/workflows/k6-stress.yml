name: k6 Stress Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Run single test or all'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - load
          - load-500
          - load-7000

jobs:
  stress:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.test_suite != 'all' && fromJSON(format('["{0}"]', github.event.inputs.test_suite)) || fromJSON('["smoke","load","load-500","load-7000"]') }}
    steps:
      - uses: actions/checkout@v4

      - name: Create results dir
        run: |
          mkdir -p results
          chmod 777 results

      - name: Run k6 ${{ matrix.test }}
        env:
          K6_SUMMARY_PATH: /scripts/results/${{ matrix.test }}.json
        run: |
          case "${{ matrix.test }}" in
            smoke)   script="smoke.js" ;;
            load)    script="load.js" ;;
            load-500) script="load-500.js" ;;
            load-7000) script="load-7000.js" ;;
            *) exit 1 ;;
          esac
          docker run --rm -v $PWD:/scripts -e K6_SUMMARY_PATH=/scripts/results/${{ matrix.test }}.json \
            grafana/k6 run /scripts/stress/$script

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: summary-${{ matrix.test }}
          path: results/${{ matrix.test }}.json

  report:
    runs-on: ubuntu-latest
    needs: stress
    if: always() && (needs.stress.result == 'success' || needs.stress.result == 'failure')
    steps:
      - uses: actions/checkout@v4

      - name: Download all summaries
        uses: actions/download-artifact@v4
        with:
          pattern: summary-*
          path: artifacts
          merge-multiple: true

      - name: Prepare results for report
        run: |
          mkdir -p results
          find artifacts -name "*.json" -exec sh -c 'cp "$1" results/$(basename "$1")' _ {} \;
          ls -la results/

      - name: Generate HTML report
        run: node scripts/generate-report.js

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: k6-stress-report
          path: |
            results/index.html
            results/*.json
